# Лабораторная работа №2: временные ряды

В данной лабораторной работе нужно будет научиться работать с временными рядами. Данные представляют собой курс иностранной валюты (евро) за последние несколько лет. Ваша задача проанализировать эти данные и научиться прогнозировать
будущие значения.
 
Метрика качества — `Meab Absolute Error`.

Установите библиотеку для работы с временными рядами: [Statsmodels](https://www.statsmodels.org/stable/index.html).

Скачайте [архив с данными](https://drive.google.com/file/d/1fdjCswQ64LnhdNPiATE5HbmSZuKDsCSf/view?usp=sharing).

Максимальная оценка за работу без задания повышенной сложности — `8`.


### 1. Разведочный анализ данных

1. Загрузите данные.
2. Используя метод скользящего среднего, сгладьте временной ряд. Ширину окна выбирайте равной одной недели, месяцу, кварталу.
3. На одной графике изобразите исходный временной ряд, а также его сглаженные версии. Есть ли у ряда тренд, сезонность?
4. Является ли заданный временной ряд стационарным? Почему? Проверьте своё предположение с помощью теста [Дики-Фуллера](https://ru.wikipedia.org/wiki/Тест_Дики_—_Фуллера).


### 2. Кросс-валидация

Реализуйте функцию `cross_val_on_time_series`, которая разбивает обучающие данные на группы, затем для каждой из них обучает переданный регрессор, 
предсказывает значения для тестовых данных и возвращает список из значений по целевой метрики для пресказанных и реальных значений.

Функция должна иметь следующие входные параметры: 

1. `regressor` — регрессор, для которого реализованы методы `fit` и `predict`
2. `X` — матрица признаков для примеров (упорядоченных по времени)
3. `y` — значения целевой переменной (упорядоченные по времени)
4. `n_splits` — количество разбиений для временного ряда
5. `metric` — целевая метрика (см. `sklearn.metrics`, а также услвоие лабораторной работы)

Примечание: для разбиения данных на группы рекомендуется использовать `TimeSeriesSplit` из `sklearn.model_selection`.


### 3. Прогнозирование с использованием матрицы признаков

1. Напишите функцию `create_time_series_features`, которая создает матрицу признаков для переданного временного
ряда на основе времени наблюдения целевой переменной.
2. Создайте матрицу признаков для заданного временного ряда.
3. Сравните производительность следующих алгоритмов, используя кросс-валидацию 
(подумайте, нужно ли использовать функцию из предыдущего задания):

* `SGDRegressor`
* `LinearRegression`
* `RandomForestRegressor`
* `XGBRegressor/LGBMRegressor`

4. Обучите бустинг-модель и постройте график важности признаков (`feature_importances`).
5. Разбейте временной ряд на тренировочный и тестовый так, чтобы в тестовой части были данные за 2 последних месяца. 
Обучите по одной линейной и древесной модели, которые показали себя лучше всего в 3-м пункте, и спрогнозируйте значения для тестовых данных и тренировочных данных. 
6. На одном графике изобразите исходный временной ряд и предсказания всех моделей, построенных в предыдущем пункте.
Используйте разные цвета для истинных и предсказанных значений. Прогнозы разных моделей также изображайте разными цветами. Добавьте на график легенду.
Выделите участок, на котором изображаются предсказания для тестовых данных (например, сделайте фон темнее).
7. Попробуйте улучшить работу алгоритмов, подбирая параметры моделей или изменяя исходный ряд, например, при помощи 
[преобразования Бокса-Кокса](http://www.machinelearning.ru/wiki/index.php?title=Метод_Бокса-Кокса).


### 4. Авторегрессия

1. Построейте модель авторегресии и, используя результаты 3-го задания, оцените работу алгоритма при помощи кросс-валидации.
2. Удалите из ряда тренд и вновь проведите кросс-валидацию модели. Прокомментируйте результаты, сравните их с теми, что получены во 2-м
пункте лабораторной работы.

Примечание: тренд можно удалять явно, обучая функцию от времени, например, линейную квадратичную и т.д., или дифференцируя исходный ряд 
(в этом случае подумайте, как строить прогноз для исходного ряда).

3. Действую по аналогии с пунктом 6 задания 3, предскажите значения для всего временного промежутка и добавьте их на график с 
другими моделями.
4. Попробуйте улучшить качество модели.
  

### 5. *ARIMA  

1. Постройте модель ARIMA и подберите её параметры (например, основываясь на 
[AIC](https://ru.wikipedia.org/wiki/Информационный_критерий_Акаике)- информационном критерии Акаике).
2. Имеет ли смысл для данного временного ряда исполозовать модель SARIMA? Почему?
3. Оцените качество построенной модели.
4. Действуя по аналогии с предыдущими пунктами, сравните результаты разных моделей, постройте совместный график для предсказанных значений 
на всем временном промежутке.


### 6. Построение прогнозов

1. Используя результаты предыдущих пунктов, предскажите значения временного ряда на период с `28.10.2019` по `11.11.2019`. 
2. Сохраните результат в файле `submission_ФамилияИмя.csv` и вместе с отчетом отправьте преподавателю. В файле должно быть два столбца:
Date — дата, для которой строится прогноз, в формате `Year-Month-Day`(например, `2019-01-31`); Rate — значение целевой переменной 
(см. файл с данными, а также 
[пример записи предсказаний](https://nbviewer.jupyter.org/github/uladzislau-varabei/machine-learning-course-bsu-mmf-2019-autumn/blob/master/LB_02/Submission_example.ipynb)).


__Ваша итоговая оценка будет зависеть от качества построенных прогнозов. Также имейте ввиду, что для работ не сданных в срок, 
оценка за предсказания может быть уменьшена до 0, поскольку у вас будет доступ к значениям целевой переменной, что даст возможность
подстроить под них модель.__


## Перед выполнением работы рекомендуется ознакомиться со следующими материалами:
1. [Анализ временных рядов с помощью Python](https://habr.com/ru/company/ods/blog/327242/)
2. [Анализ временных рядов с помощью Python (2)](https://habr.com/ru/post/207160/)

__Срок сдачи работы: `27 октября 2019`.__
